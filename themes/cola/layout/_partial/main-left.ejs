<%
  const posts = site.posts
  const archives = [], activetiesDate = []
  site.posts.each(function(post) {
    activetiesDate.push(post.updated)
    const _date = date(post.date, 'YYYYMM')
    if (!archives.includes(_date)) {
      archives.push(_date)
    }
  })

  const activityDate = Math.max(...activetiesDate)
  const activity = Math.floor((Date.now() - activityDate) / 1000 / 60 / 60 / 24)
  let activityText = ''
  if (activity === 0) {
    activityText = '今天'
  } else if (activity === 1) {
    activityText = '昨天'
  } else if (activity < 7) {
    activityText = activity + '天前'
  } else if (activity >= 7 && activity < 30) {
    activityText = Math.floor(activity / 7) + '周前'
  } else if (activity >= 30 && activity < 365) {
    activityText = Math.floor(activity / 30) + '月前'
  } else if (activity >= 365) {
    activityText = Math.floor(activity / 365) + '年前'
  }

  const menu = theme.menu.map(m => ({
    title: m[0],
    path: m[1],
    icon: m[2],
  }))

  const currDate = Date.now()
  const publicDate = new Date(theme.public_date).getTime()
  const runningDate = Math.ceil((currDate - publicDate) / 1000 / 60 / 60 / 24)
%>
<div class="main-left">
  <div class="main-left--block">
    <div class="main-left--info">
      <img src="<%- url_for('imgs/head.jpg') %>"" class="main-left--head" />
      <div class="main-left--intro">
        <p class="main-left--name"><%- theme.author_name %></p>
        <div class="main-left--tags">
          <span class="main-left--tag"><%- theme.tag1 %></span>
          <span class="main-left--tag"><%- theme.tag2 %></span>
        </div>
      </div>
    </div>
  
    <div>
      <div class="main-left--motto">
        <p><%- theme.motto_prev %></p>
        <p><%- theme.motto_last %></p>
      </div>
      <div class="main-left--github">
        <span class="line"></span>
        <a href="<%- theme.github_url %>"><i class="logo iconfont icon-github-fill"></i></a>
        <span class="line"></span>
      </div>
      <div class="main-left--statics">
        <a href="/categories">
          <div>
            <span><%- site.categories.length %></span>
            <span>分类</span>
          </div>
        </a>
        <a href="/tags">
          <div>
            <span><%- site.tags.length %></span>
            <span>标签</span>
          </div>
        </a>
        <a href="/archives">
          <div>
            <span><%- archives.length %> </span>
            <span>归档</span>
          </div>
        </a>
      </div>
    </div>
  </div>

  <div class="main-left--block">
    <ul class="main-left--menu">
      <% menu.forEach(function(m){ %>
        <li>
          <a href="<%- m.path %>">
            <span class="header-menu--span"><%- m.title %></span>
            <i class="header-menu--icon iconfont <%- m.icon %>"></i>
          </a>
        </li>
      <% }) %>
    </ul>
  </div>

  <div class="main-left--block">
    <div class="main-left--site">
      <h5 class="main-left--title">
        <span>站点信息</span>
        <i class="iconfont icon-zhandian"></i>
      </h5>
      <p class="main-left--subtitle">
        <span>文章数目：</span>
        <span><%- site.posts.length %> 篇</span>
      </p>
      <p class="main-left--subtitle">
        <span>最近动态：</span>
        <span><%- activityText %></span>
      </p>
      <p class="main-left--subtitle">
        <span>上线时间：</span>
        <!-- server-rendered fallback; JS will update this value on the client using data-public-date -->
        <span id="site-running-days" data-public-date="<%- theme.public_date %>"><%- runningDate %>天</span>
      </p>
      <p class="main-left--subtitle">
        <span>当前版本：</span>
        <span>v<%- theme.version %></span>
      </p>
    </div>
  </div>
</div>

<script>
  // 客户端动态计算上线天数（保留服务端渲染值作为回退）
  (function () {
    try {
      var el = document.getElementById('site-running-days')
      if (!el) return
      var pd = el.getAttribute('data-public-date')
      if (!pd) return
      var publicTs = new Date(pd).getTime()
      if (isNaN(publicTs)) return
      function updateDays () {
        var now = Date.now()
        var days = Math.ceil((now - publicTs) / (1000 * 60 * 60 * 24))
        el.textContent = days + '天'
      }
      // 初次更新
      updateDays()
      // 可选：在页面打开期间按日更新一次（在午夜刷新会更精确）。这里设置为每小时检查以保证在长时间打开页面时也能更新。
      setInterval(updateDays, 1000 * 60 * 60)
    } catch (e) {
      console && console.error && console.error('site running days update error:', e)
    }
  })()
</script>