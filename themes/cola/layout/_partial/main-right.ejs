<div class="main-right">
  <div class="main-right--board">
    <div class="main-right--title">
      <h5>公告栏</h5>
      <i class="iconfont icon-gonggao"></i>
    </div>
    <div class="main-right--content">
      <%- theme.notice %> 
    </div>
  </div>

  <!-- <div id="aplayer" class="main-right--music"></div> -->

  <div class="operate-items">
    <div class="operate-item backtop">
      <i class="iconfont icon-huidaodingbu"></i>
      <span>回到顶部</span>
    </div>
    <% if (theme.comments.enable) { %>
    <div class="operate-item turn-comment hidden">
      <i class="iconfont icon-pinglun"></i>
      <span>查看评论</span>
    </div>
    <% } %>
  </div>

  <div class="main-right--site">
    <div class="main-right--power">
      <p>Power By <a href="https://hexo.io/zh-cn/docs/">Hexo</a>.</p>
      <p>Theme：<a href="https://github.com/Aizener/hexo-theme-cola">Cola.</a></p>
    </div>
    <p class="main-right--refer">
        Copyright © <span id="site-year"><%= new Date().getFullYear() %></span> 
    </p>
    <p class="main-right--icp">
        <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer"><%= theme.siteicp %></a>
    </p>
  </div>
  <script>
    // 客户端覆盖年份（保留服务端回退以兼容无 JS 场景）
    (function () {
      try {
        var y = new Date().getFullYear()
        var el = document.getElementById('site-year')
        if (el) el.textContent = y
      } catch (e) {
        console && console.error && console.error('set site year error:', e)
      }
    })()
  </script>
</div>
<%
  // Guard against missing `theme.musics` to avoid runtime errors during EJS rendering.
  const musics = (theme && theme.musics && Array.isArray(theme.musics)) ? theme.musics.map(item => ({
    name: item[0],
    artist: item[1],
    url: item[2],
    cover: url_for(item[3]),
  })) : []
%>
<script>
  function setOperateItem () {
    const reg = /\d{4}\/\d{2}\/\d{2}\/.+/
    const path = location.pathname
    const operateDom = document.querySelector('.main-right .operate-items')
    const commentDom = document.querySelector('.turn-comment')
    const cateloguDom = document.querySelector('.article-catelogue > .article-catelogue--wrapper');

    if (commentDom) {
      if (reg.test(path) || path.match(/\/log\/.+/)) {
        commentDom.classList.remove('hidden')
        const newDom = operateDom.cloneNode(true);
        const _backtopDom = newDom.querySelector('.backtop');
        const _commentDom = newDom.querySelector('.turn-comment');
        _backtopDom.addEventListener('click', () => backTopEvent());
        _commentDom.addEventListener('click', () => commentDomEvent());
        cateloguDom.appendChild(newDom);
      } else {
        commentDom.classList.add('hidden')
      }
    }
  }

  setOperateItem()
  // const musics = JSON.parse(`<%- JSON.stringify(musics) %>`)
  // const ap = new APlayer({
  //   container: document.querySelector('#aplayer'),
  //   audio: musics,
  // })

  $(document).on('pjax:complete', function() {
    setOperateItem()
  })

  document.querySelector('.backtop').addEventListener('click', () => {
    backTopEvent();
  })
  const dom = document.querySelector('.turn-comment')
  dom && dom.addEventListener('click', () => {
    commentDomEvent();
  })

  function backTopEvent() {
    document.documentElement.scrollTo({
      top: 0,
      behavior: 'smooth'
    })
  }

  function commentDomEvent() {
    const commentDom = document.querySelector('.comments-intro')
    if (!commentDom) return
    const top = commentDom.offsetTop, height = commentDom.offsetHeight
    document.documentElement.scrollTo({
      top: top - 2 * height,
      behavior: 'smooth'
    })
  }
</script>