<head>
  <meta charset="utf-8">
  <%
    const baseTitle = config.title
    const pageTitle = page.title || '首页'
    const title = '小栈 ' + pageTitle
  %>
  <title><% if (title){ %><%= title %> | <% } %><%= config.title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="<%- url_for('imgs/shortcut-icon.ico') %>" type="image/x-icon">
  <link rel="stylesheet" href="<%- url_for('css/public.css') %>" />
  <link rel="stylesheet" href="<%- url_for('css/layout.css') %>" />
  <link rel="stylesheet" href="<%- url_for('css/iconfont.css') %>" />
  <link rel="stylesheet" href="<%- url_for('css/APlayer.min.css') %>" />
  <script src="<%- url_for('js/APlayer.min.js') %>"></script>
  <script src="<%- url_for('js/jquery.min.js') %>"></script>
  <script src="<%- url_for('js/jquery.pjax.min.js') %>"></script>

  <!-- MathJax: load only when page contains LaTeX markers -->
  <script>
    (function() {
      const MATHJAX_ID = 'mathjax-script';
      const MATHJAX_CDN = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';

      function hasLatexContent() {
        // Look inside article content first for performance
        const article = document.querySelector('.article-content');
        const hay = (article && article.textContent) ? article.textContent : document.body.textContent || '';
        if (!hay) return false;
        // Common TeX delimiters and environment starts
        const re = /\\\(|\\\]|\\\[|\\begin\{|\$\$|\$(?!\s)|\\\)/;
        return re.test(hay);
      }

      function loadMathJaxOnce(callback) {
        if (window.MathJax) { return callback && callback(); }
        if (document.getElementById(MATHJAX_ID)) {
          // already loading; wait for load
          document.getElementById(MATHJAX_ID).addEventListener('load', function onload() {
            this.removeEventListener('load', onload);
            callback && callback();
          });
          return;
        }
        const s = document.createElement('script');
        s.id = MATHJAX_ID;
        s.src = MATHJAX_CDN;
        s.async = true;
        s.onload = function() {
          try {
            // configure minimal common input; keep auto startup off
            if (window.MathJax && window.MathJax.startup && window.MathJax.startup.defaultOptions) {
              // MathJax v3
              window.MathJax = window.MathJax || {};
            }
          } catch (e) {
            console.warn('MathJax init warning', e);
          }
          callback && callback();
        };
        s.onerror = function() { console.error('Failed to load MathJax'); };
        document.head.appendChild(s);
      }

      function typesetArticle() {
        const article = document.querySelector('.article-content');
        if (!article) return;
        // For MathJax v3
        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
          try { window.MathJax.typesetPromise([article]); } catch (e) { console.warn('MathJax typeset error', e); }
        } else if (window.MathJax && window.MathJax.Hub && typeof window.MathJax.Hub.Queue === 'function') {
          // fallback for v2
          try { window.MathJax.Hub.Queue(['Typeset', window.MathJax.Hub, article]); } catch (e) { console.warn('MathJax v2 typeset error', e); }
        }
      }

      function maybeLoadAndTypeset() {
        if (!hasLatexContent()) return;
        loadMathJaxOnce(function() {
          // Wait a tick so MathJax registers
          requestAnimationFrame(typesetArticle);
        });
      }

      // Run on initial load and on pjax complete
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        maybeLoadAndTypeset();
      } else {
        document.addEventListener('DOMContentLoaded', maybeLoadAndTypeset);
      }
      if (window.jQuery) {
        $(document).on('pjax:complete', maybeLoadAndTypeset);
      } else {
        document.addEventListener('pjax:complete', maybeLoadAndTypeset);
      }
    })();
  </script>

  <!-- <script src='//unpkg.com/valine/dist/Valine.min.js'></script> -->
  <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
  <link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet' />
  <script>
    document.title = `<%- title %>`
  </script>
</head>